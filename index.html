<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro por Eventos</title>
  <link rel="icon" href="icons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  <link rel="apple-touch-icon" href="icons/icon-180x180.png" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #101315;
      --panel: #1a2024;
      --text: #eef2f4;
      --muted: #a5b1b8;
      --accent: #2dc36a;
      --accent-hover: #26a95b;
      --warn: #f9c74f;
      --danger: #e76f51;
    }

    body {
      margin: 0;
      padding: 20px;
      max-width: 720px;
      margin-inline: auto;
      background: radial-gradient(circle at top left, #1d2730, var(--bg) 55%);
      color: var(--text);
      font-family: "Segoe UI", Tahoma, sans-serif;
    }

    body.modal-open {
      position: fixed;
      overflow: hidden;
      width: 100%;
    }

    h1, h2, h3 {
      margin: 0;
      font-weight: 700;
    }

    p {
      margin: 0;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .card {
      background: color-mix(in srgb, var(--panel) 88%, black 12%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
    }

    .subtitle {
      margin-top: 6px;
      color: var(--muted);
      text-align: center;
    }

    .env-badge {
      margin-top: 10px;
      text-align: center;
      color: var(--warn);
      font-size: 0.95rem;
    }

    .dev-only {
      display: none;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 14px;
    }

    label {
      font-size: 0.92rem;
      color: var(--muted);
    }

    input, select, button {
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      padding: 11px 12px;
    }

    input, select {
      background: #10161b;
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    button {
      background: var(--accent);
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background: var(--accent-hover);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #33414c;
    }

    .btn-secondary:hover {
      background: #415464;
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #d85d40;
    }

    .inline {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .checks {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: 4px;
    }

    .single-day-check {
      margin-top: -4px;
    }

    .checks label {
      color: var(--text);
      font-size: 0.92rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 4px;
    }

    .hint {
      color: var(--muted);
      font-size: 0.88rem;
    }

    .exceptions-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      align-items: center;
    }

    #modoEvento {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--warn);
      text-align: center;
    }

    #enviandoMsg {
      display: none;
      text-align: center;
      margin-top: 12px;
      color: var(--warn);
      font-weight: 600;
    }

    #eventosLoadingMsg {
      display: none;
      color: var(--warn);
      font-size: 0.9rem;
      font-weight: 600;
    }

    #listaEventos {
      min-height: 220px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      justify-content: center;
      align-items: center;
      padding: 16px;
      z-index: 20;
      overscroll-behavior: contain;
    }

    .modal-content {
      width: min(680px, 100%);
      max-height: 92vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      background: #1d252b;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .days-container input {
      margin-bottom: 8px;
      width: 100%;
    }

    .drive-link button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    @media (max-width: 640px) {
      .inline, .actions {
        grid-template-columns: 1fr;
      }

      .exceptions-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button type="button" class="btn-secondary" onclick="showModal('gananciaModal')">Ganancias</button>
    <button type="button" class="btn-secondary" onclick="showModal('diasLibresModal')">Dias libres</button>
    <a
      class="drive-link"
      href="https://docs.google.com/spreadsheets/d/1GlBG2lRCFEkdZc8q_igLwia8ekyRGtUT5qo8sWqLgH4/edit?usp=drive_link"
      target="_blank"
      rel="noreferrer"
      style="text-decoration: none;"
    >
      <button type="button" title="Abrir Sheet">
        <img src="icons/google-drive.png" alt="Google Drive" style="width:24px;height:24px;" />
      </button>
    </a>
  </div>

  <div class="card" id="formPrincipal">
    <h1>Registro por Evento</h1>
    <p class="subtitle">Crea por rango de fechas y luego recupera para actualizar.</p>
    <p id="envBadge" class="env-badge dev-only">Entorno DEV</p>

    <div id="modoEvento" class="dev-only">Modo: creando evento nuevo</div>

    <form id="formEvento">
      <input type="hidden" id="eventKey" name="eventKey" />

      <label for="evento">Nombre del evento</label>
      <input type="text" id="evento" name="evento" required />

      <div class="inline">
        <div>
          <label for="fechaInicio">Fecha inicio</label>
          <input type="date" id="fechaInicio" name="fechaInicio" required />
        </div>
        <div>
          <label for="fechaFin">Fecha fin</label>
          <input type="date" id="fechaFin" name="fechaFin" required />
        </div>
      </div>
      <label class="single-day-check"><input type="checkbox" id="soloUnDia" /> Marcar solo un dia</label>

      <label for="tarifa">Tarifa</label>
      <select id="tarifa" name="tarifa" required>
        <option value="Ninguna">Ninguna</option>
        <option value="Tec.Madrid">Tec.Madrid</option>
        <option value="Tec.Finde">Tec.Finde</option>
        <option value="Tec.Fuera">Tec.Fuera</option>
        <option value="Conductor - 400">Conductor - 400</option>
        <option value="Conductor + 400">Conductor + 400</option>
        <option value="Op.Med">Op.Med</option>
        <option value="Op.Bolo">Op.Bolo</option>
        <option value="Op. Gran Formato">Op. Gran Formato</option>
        <option value="Op.Directo">Op.Directo</option>
        <option value="JE/Op Plato">JE/Op Plato</option>
        <option value="Tec.Plato">Tec.Plato</option>
        <option value="JE.Bolo">JE.Bolo</option>
        <option value="JE.Gran Formato">JE.Gran Formato</option>
        <option value="JE.Directo">JE.Directo</option>
        <option value="Dia OFF">Dia OFF</option>
      </select>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="abrirExcepciones()">Excepciones</button>
        <span id="exceptionsSummary" class="hint">Sin excepciones</span>
      </div>

      <label for="extras">Horas extras</label>
      <select id="extras" name="extras" required>
        <option value="No">No he hecho horas extras</option>
        <option value="12 - Normal - Bolo">12 - Normal - Bolo</option>
        <option value="13 - Normal - Bolo">13 - Normal - Bolo</option>
        <option value="14 - Normal - Bolo">14 - Normal - Bolo</option>
        <option value="15 - Normal - Bolo">15 - Normal - Bolo</option>
        <option value="16 - Normal - Bolo">16 - Normal - Bolo</option>
        <option value="12 - Op/JE - Bolo">12 - Op/JE - Bolo</option>
        <option value="13 - Op/JE - Bolo">13 - Op/JE - Bolo</option>
        <option value="14 - Op/JE - Bolo">14 - Op/JE - Bolo</option>
        <option value="15 - Op/JE - Bolo">15 - Op/JE - Bolo</option>
        <option value="16 - Op/JE - Bolo">16 - Op/JE - Bolo</option>
        <option value="12 - Op/JE - GF">12 - Op/JE - GF</option>
        <option value="13 - Op/JE - GF">13 - Op/JE - GF</option>
        <option value="14 - Op/JE - GF">14 - Op/JE - GF</option>
        <option value="15 - Op/JE - GF">15 - Op/JE - GF</option>
        <option value="12 - Op/JE - Directo">12 - Op/JE - Directo</option>
        <option value="13 - Op/JE - Directo">13 - Op/JE - Directo</option>
        <option value="14 - Op/JE - Directo">14 - Op/JE - Directo</option>
        <option value="12 - Normal - Directo">12 - Normal - Directo</option>
        <option value="13 - Normal - Directo">13 - Normal - Directo</option>
        <option value="14 - Normal - Directo">14 - Normal - Directo</option>
      </select>

      <div class="checks">
        <label><input type="checkbox" id="mediaJornada" /> Media jornada</label>
        <label><input type="checkbox" id="jefeOperador" /> Jefe + Operador</label>
        <label><input type="checkbox" id="dobleJornadaReal" /> Doble jornada</label>
      </div>

      <div class="actions">
        <button type="button" class="btn-danger" onclick="resetFormularioEvento();">Nuevo evento</button>
        <button type="button" class="btn-secondary" onclick="showModal('eventosModal'); cargarListaEventos();">Recuperar evento</button>
        <button type="button" class="btn-danger" id="deleteEventoBtn" onclick="eliminarEventoActual();" disabled>Eliminar evento</button>
        <button type="submit" id="submitEventoBtn">Guardar evento</button>
      </div>
    </form>
  </div>

  <div id="excepcionesModal" class="modal">
    <div class="modal-content">
      <h3>Excepciones de tarifa</h3>
      <p class="hint">Define fechas concretas con tarifa distinta dentro del rango.</p>
      <div id="excepcionesRows"></div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="agregarExcepcionRow()">Agregar fila</button>
        <button type="button" onclick="guardarExcepcionesModal()">Guardar excepciones</button>
        <button type="button" class="btn-secondary" onclick="closeModal('excepcionesModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="eventosModal" class="modal">
    <div class="modal-content">
      <h3>Recuperar evento</h3>
      <label for="buscarEventoTxt">Buscar por nombre</label>
      <input type="text" id="buscarEventoTxt" placeholder="Escribe para filtrar" />
      <button type="button" class="btn-secondary" onclick="cargarListaEventos()">Actualizar lista</button>
      <div id="eventosLoadingMsg" aria-live="polite">Leyendo datos...</div>

      <label for="listaEventos">Eventos encontrados</label>
      <select id="listaEventos"></select>

      <div class="modal-actions">
        <button type="button" onclick="cargarEventoSeleccionado()">Cargar evento</button>
        <button type="button" class="btn-secondary" onclick="closeModal('eventosModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="diasLibresModal" class="modal">
    <div class="modal-content">
      <h3>Asignar dias libres</h3>
      <label for="mesDiasLibres">Mes</label>
      <select id="mesDiasLibres" name="mes"></select>
      <div id="days-container" class="days-container"></div>
      <div class="modal-actions">
        <button type="button" onclick="enviarDiasLibres()">Enviar</button>
        <button type="button" class="btn-secondary" onclick="closeModal('diasLibresModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="gananciaModal" class="modal">
    <div class="modal-content">
      <h3>Consultar ganancia</h3>
      <label for="mesGanancia">Mes</label>
      <select id="mesGanancia" name="mes"></select>
      <div class="modal-actions">
        <button type="button" onclick="consultarGanancia()">Consultar</button>
        <button type="button" class="btn-secondary" onclick="closeModal('gananciaModal')">Cerrar</button>
      </div>
      <div id="gananciasResultado" style="margin-top: 8px;"></div>
    </div>
  </div>

  <div id="enviandoMsg">Enviando datos...</div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwrgAgbS8C4TqhU5Uw-MFHAbb9moH8c9Mlnh4Rjv7XNiUNlRdYYQCap-PUTDXe9RcI/exec";
    let currentEventKey = "";
    let listaEventosRequestId = 0;
    let currentExceptions = {};
    let backendHealth = null;
    let lockedScrollTop = 0;

    function isDevContext() {
      const params = new URLSearchParams(window.location.search);
      if (params.get("dev") === "1") return true;
      const host = (window.location.hostname || "").toLowerCase();
      if (host === "localhost" || host === "127.0.0.1") return true;
      return host.endsWith(".netlify.app") && host.includes("--");
    }

    function applyEnvironmentUi() {
      const showDevUi = isDevContext();
      document.querySelectorAll(".dev-only").forEach((el) => {
        el.style.display = showDevUi ? "" : "none";
      });
    }

    const MONTH_OPTIONS = [
      "Enero - 2026", "Febrero - 2026", "Marzo - 2026", "Abril - 2026",
      "Mayo - 2026", "Junio - 2026", "Julio - 2026", "Agosto - 2026",
      "Septiembre - 2026", "Octubre - 2026", "Noviembre - 2026", "Diciembre - 2026"
    ];

    function mostrarMensajeEnviando(mostrar = true) {
      document.getElementById("enviandoMsg").style.display = mostrar ? "block" : "none";
    }

    function toLocalIso(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function initMonthSelects() {
      ["mesDiasLibres", "mesGanancia"].forEach((id) => {
        const select = document.getElementById(id);
        select.innerHTML = "";
        MONTH_OPTIONS.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v.replace(" - 2026", "");
          select.appendChild(opt);
        });
      });

      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      const currentMonthText = `${monthNames[new Date().getMonth()]} - 2026`;
      ["mesDiasLibres", "mesGanancia"].forEach((id) => {
        const select = document.getElementById(id);
        if ([...select.options].some((o) => o.value === currentMonthText)) {
          select.value = currentMonthText;
        }
      });
    }

    function showModal(id) {
      lockBodyScroll();
      document.getElementById("formPrincipal").style.display = "none";
      document.getElementById(id).style.display = "flex";
      if (id === "diasLibresModal") generateNumberFields("days-container");
      if (id === "excepcionesModal") renderExcepcionesRows();
      if (id === "eventosModal") {
        document.getElementById("buscarEventoTxt").value = "";
        applyMobileUiTweaks();
        mostrarMensajeEventos(false);
      }
    }

    function closeModal(id) {
      document.getElementById(id).style.display = "none";
      document.getElementById("formPrincipal").style.display = "block";
      if (id === "eventosModal") {
        mostrarMensajeEventos(false);
      }
      unlockBodyScroll();
    }

    function generateNumberFields(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      for (let i = 1; i <= 10; i++) {
        const input = document.createElement("input");
        input.type = "number";
        input.min = "1";
        input.max = "31";
        input.placeholder = `Dia ${i}`;
        container.appendChild(input);
      }
    }

    function applyMobileUiTweaks() {
      const lista = document.getElementById("listaEventos");
      if (!lista) return;
      lista.size = window.matchMedia("(max-width: 640px)").matches ? 6 : 8;
    }

    function lockBodyScroll() {
      if (document.body.classList.contains("modal-open")) return;
      lockedScrollTop = window.scrollY || window.pageYOffset || 0;
      document.body.classList.add("modal-open");
      document.body.style.top = `-${lockedScrollTop}px`;
    }

    function unlockBodyScroll() {
      if (!document.body.classList.contains("modal-open")) return;
      document.body.classList.remove("modal-open");
      document.body.style.top = "";
      window.scrollTo(0, lockedScrollTop);
    }

    function maybeWarnCalendars(data) {
      if (!data) return;
      const n = Number(data.calendarsProcesados || data.calendarsResolved || 0);
      if (!n || n >= 2) return;
      const key = `calwarn:${data.version || "unknown"}:${n}`;
      if (sessionStorage.getItem(key)) return;
      sessionStorage.setItem(key, "1");
      alert(`Atencion: backend con ${n} calendario(s) activo(s). Revisa CALENDAR_ID_1 y CALENDAR_ID_2.`);
    }

    function mostrarMensajeEventos(mostrar = true, texto = "Leyendo datos...") {
      const el = document.getElementById("eventosLoadingMsg");
      if (!el) return;
      el.textContent = texto;
      el.style.display = mostrar ? "block" : "none";
    }

    async function postForm(params) {
      const body = params instanceof URLSearchParams ? params : new URLSearchParams(params || {});
      const res = await fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: body.toString(),
        cache: "no-store"
      });
      const raw = await res.text();
      let data;
      try {
        data = JSON.parse(raw);
      } catch (err) {
        throw new Error("Respuesta no valida del backend");
      }
      return data;
    }

    async function checkBackendHealth() {
      const fd = new URLSearchParams();
      fd.append("modo", "health");
      try {
        backendHealth = await postForm(fd);
        maybeWarnCalendars(backendHealth);
      } catch (err) {
        // no-op
      }
    }

    function setModoEvento() {
      const modo = currentEventKey ? `Modo: editando evento (${currentEventKey})` : "Modo: creando evento nuevo";
      document.getElementById("modoEvento").textContent = modo;
      document.getElementById("submitEventoBtn").textContent = currentEventKey ? "Actualizar evento" : "Guardar evento";
      document.getElementById("deleteEventoBtn").disabled = !currentEventKey;
      document.getElementById("eventKey").value = currentEventKey || "";
      updateExceptionsSummary();
    }

    function applySingleDayMode() {
      const onlyOneDay = document.getElementById("soloUnDia").checked;
      const fechaInicioEl = document.getElementById("fechaInicio");
      const fechaFinEl = document.getElementById("fechaFin");
      if (onlyOneDay) {
        if (fechaInicioEl.value) fechaFinEl.value = fechaInicioEl.value;
        fechaFinEl.disabled = true;
      } else {
        fechaFinEl.disabled = false;
      }
    }

    function resetFormularioEvento() {
      currentEventKey = "";
      currentExceptions = {};
      const form = document.getElementById("formEvento");
      form.reset();
      const today = toLocalIso(new Date());
      document.getElementById("fechaInicio").value = today;
      document.getElementById("fechaFin").value = today;
      document.getElementById("soloUnDia").checked = true;
      applySingleDayMode();
      document.getElementById("extras").value = "No";
      document.getElementById("tarifa").value = "Ninguna";
      setModoEvento();
    }

    function updateExceptionsSummary() {
      const total = Object.keys(currentExceptions || {}).length;
      document.getElementById("exceptionsSummary").textContent =
        total > 0 ? `${total} excepcion(es)` : "Sin excepciones";
    }

    function abrirExcepciones() {
      showModal("excepcionesModal");
    }

    function createTarifaSelect(selectedValue) {
      const source = document.getElementById("tarifa");
      const select = document.createElement("select");
      select.className = "exception-tarifa";
      [...source.options].forEach((opt) => {
        const n = document.createElement("option");
        n.value = opt.value;
        n.textContent = opt.textContent;
        if (opt.value === selectedValue) n.selected = true;
        select.appendChild(n);
      });
      if (![...select.options].some((o) => o.value === selectedValue)) {
        select.value = "Ninguna";
      }
      return select;
    }

    function appendExcepcionRow(fecha = "", tarifa = "Ninguna") {
      const wrapper = document.createElement("div");
      wrapper.className = "exceptions-row";

      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.className = "exception-date";
      dateInput.value = fecha || "";

      const tarifaSelect = createTarifaSelect(tarifa || "Ninguna");

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "btn-danger";
      removeBtn.textContent = "Quitar";
      removeBtn.onclick = () => wrapper.remove();

      wrapper.appendChild(dateInput);
      wrapper.appendChild(tarifaSelect);
      wrapper.appendChild(removeBtn);

      document.getElementById("excepcionesRows").appendChild(wrapper);
    }

    function renderExcepcionesRows() {
      const container = document.getElementById("excepcionesRows");
      container.innerHTML = "";
      const entries = Object.entries(currentExceptions || {}).sort((a, b) => a[0].localeCompare(b[0]));
      if (!entries.length) {
        appendExcepcionRow("", document.getElementById("tarifa").value || "Ninguna");
        return;
      }
      entries.forEach(([fecha, tarifa]) => appendExcepcionRow(fecha, tarifa));
    }

    function agregarExcepcionRow() {
      appendExcepcionRow("", document.getElementById("tarifa").value || "Ninguna");
    }

    function guardarExcepcionesModal() {
      const rows = [...document.querySelectorAll("#excepcionesRows .exceptions-row")];
      const ex = {};
      rows.forEach((row) => {
        const fecha = row.querySelector(".exception-date").value;
        const tarifa = row.querySelector(".exception-tarifa").value;
        if (!fecha || !tarifa) return;
        ex[fecha] = tarifa;
      });
      currentExceptions = ex;
      updateExceptionsSummary();
      closeModal("excepcionesModal");
    }

    async function cargarListaEventos() {
      const lista = document.getElementById("listaEventos");
      const requestId = ++listaEventosRequestId;
      lista.innerHTML = "";
      const query = document.getElementById("buscarEventoTxt").value.trim();

      const fd = new URLSearchParams();
      fd.append("modo", "listarEventos");
      if (query) fd.append("q", query);

      mostrarMensajeEventos(true, "Leyendo datos...");
      try {
        const data = await postForm(fd);
        if (requestId !== listaEventosRequestId) return;
        mostrarMensajeEventos(false);
        if (data.error) {
          alert(data.error);
          return;
        }
        maybeWarnCalendars(data);

        const byKey = new Map();
        (data.events || []).forEach((ev) => {
          if (!ev || !ev.eventKey) return;
          if (!byKey.has(ev.eventKey)) byKey.set(ev.eventKey, ev);
        });
        const events = [...byKey.values()];
        if (!events.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No hay eventos guardados";
          lista.appendChild(opt);
          return;
        }

        events.forEach((ev) => {
          const opt = document.createElement("option");
          opt.value = ev.eventKey;
          opt.textContent = `${ev.evento} | ${ev.fechaInicio} -> ${ev.fechaFin} (${ev.dias} dias)`;
          lista.appendChild(opt);
        });
      } catch (err) {
        if (requestId !== listaEventosRequestId) return;
        mostrarMensajeEventos(false);
        alert("Error al cargar eventos");
      }
    }

    async function cargarEventoPorKey(key, cerrarModal = true) {
      const fd = new URLSearchParams();
      fd.append("modo", "obtenerEvento");
      fd.append("eventKey", key);

      mostrarMensajeEventos(true, "Leyendo datos del evento...");
      try {
        const data = await postForm(fd);
        mostrarMensajeEventos(false);
        if (data.error) {
          alert(data.error);
          return false;
        }

        const ev = data.event;
        currentEventKey = ev.eventKey;
        document.getElementById("evento").value = ev.evento || "";
        document.getElementById("fechaInicio").value = ev.fechaInicio || "";
        document.getElementById("fechaFin").value = ev.fechaFin || "";
        document.getElementById("soloUnDia").checked = !!ev.fechaInicio && ev.fechaInicio === ev.fechaFin;
        applySingleDayMode();
        document.getElementById("tarifa").value = ev.tarifa || "Ninguna";
        document.getElementById("extras").value = ev.extras || "No";
        document.getElementById("mediaJornada").checked = !!ev.mediaJornada;
        document.getElementById("jefeOperador").checked = !!ev.jefeOperador;
        document.getElementById("dobleJornadaReal").checked = !!ev.dobleJornada;
        currentExceptions = ev.excepciones || {};
        setModoEvento();
        if (cerrarModal) closeModal("eventosModal");
        return true;
      } catch (err) {
        mostrarMensajeEventos(false);
        alert("Error al cargar el evento");
        return false;
      }
    }

    async function cargarEventoSeleccionado() {
      const key = document.getElementById("listaEventos").value;
      if (!key) return alert("Selecciona un evento");
      await cargarEventoPorKey(key, true);
    }

    async function manejarConflictoEvento(data) {
      if (!data || !data.conflictEventKey) {
        alert(data && data.error ? data.error : "Error al guardar");
        return;
      }

      const aceptar = confirm(
        "Ese rango ya pertenece a otro evento. ¿Quieres cargarlo para editarlo?"
      );
      if (!aceptar) {
        alert(data.error);
        return;
      }

      const ok = await cargarEventoPorKey(data.conflictEventKey, false);
      if (ok) {
        alert("Evento conflictivo cargado. Revisa los datos y pulsa Actualizar evento.");
      }
    }

    async function eliminarEventoActual() {
      if (!currentEventKey) {
        alert("Primero carga un evento para eliminar.");
        return;
      }

      const ok = confirm("Se eliminara el evento completo: Sheets y calendarios. ¿Continuar?");
      if (!ok) return;

      const fd = new URLSearchParams();
      fd.append("modo", "eliminarEvento");
      fd.append("eventKey", currentEventKey);

      mostrarMensajeEnviando(true);
      try {
        const data = await postForm(fd);
        mostrarMensajeEnviando(false);
        if (data.error) return alert(data.error);
        maybeWarnCalendars(data);

        alert(`Evento eliminado (${data.diasEliminados || 0} dias).`);
        resetFormularioEvento();
      } catch (err) {
        mostrarMensajeEnviando(false);
        alert("Error al eliminar el evento");
      }
    }

    async function enviarDiasLibres() {
      const dias = [...document.querySelectorAll("#days-container input")]
        .map((i) => i.value.trim())
        .filter(Boolean);
      if (!dias.length) return alert("Introduce al menos un dia");

      const fd = new URLSearchParams();
      fd.append("modo", "diasLibres");
      fd.append("mes", document.getElementById("mesDiasLibres").value);
      fd.append("dias", dias.join(","));

      mostrarMensajeEnviando(true);
      try {
        const data = await postForm(fd);
        mostrarMensajeEnviando(false);
        if (data.error) return alert(data.error);
        maybeWarnCalendars(data);
        const asignados = Number(data.dias || 0);
        const solicitados = Number(data.solicitados || asignados);
        if (solicitados !== asignados) {
          alert(`Dias libres asignados ${asignados}/${solicitados}`);
        } else {
          alert(`Dias libres asignados (${asignados})`);
        }
      } catch (err) {
        mostrarMensajeEnviando(false);
        alert("Error al asignar dias libres");
      }
    }

    async function consultarGanancia() {
      const fd = new URLSearchParams();
      const mes = document.getElementById("mesGanancia").value;
      fd.append("modo", "consulta");
      fd.append("mes", mes);

      const output = document.getElementById("gananciasResultado");
      output.textContent = "Cargando...";

      try {
        const data = await postForm(fd);
        if (data.error) {
          output.textContent = `Error: ${data.error}`;
          return;
        }
        output.innerHTML = `<b>${mes}</b><br>Total: <b>${data.total} EUR</b><br>Real: <b>${data.real} EUR</b>`;
      } catch (err) {
        output.textContent = "Error al consultar";
      }
    }

    document.getElementById("formEvento").addEventListener("submit", async (e) => {
      e.preventDefault();

      const evento = document.getElementById("evento").value.trim();
      const fechaInicio = document.getElementById("fechaInicio").value;
      const onlyOneDay = document.getElementById("soloUnDia").checked;
      const fechaFinEl = document.getElementById("fechaFin");
      if (onlyOneDay && fechaInicio) fechaFinEl.value = fechaInicio;
      const fechaFin = fechaFinEl.value;
      if (!evento) return alert("Falta nombre del evento");
      if (!fechaInicio || !fechaFin) return alert("Completa fechas");
      if (fechaInicio > fechaFin) return alert("La fecha final debe ser mayor o igual");

      const fd = new URLSearchParams();
      fd.append("modo", currentEventKey ? "actualizarEvento" : "guardarEventoRango");
      if (currentEventKey) fd.append("eventKey", currentEventKey);
      fd.append("evento", evento);
      fd.append("fechaInicio", fechaInicio);
      fd.append("fechaFin", fechaFin);
      fd.append("tarifa", document.getElementById("tarifa").value);
      fd.append("excepciones", JSON.stringify(currentExceptions || {}));
      fd.append("extras", document.getElementById("extras").value);
      fd.append("mediaJornada", document.getElementById("mediaJornada").checked);
      fd.append("jefeOperador", document.getElementById("jefeOperador").checked);
      fd.append("Doble jornada", document.getElementById("dobleJornadaReal").checked);

      mostrarMensajeEnviando(true);
      try {
        const data = await postForm(fd);
        mostrarMensajeEnviando(false);
        if (data.error) return manejarConflictoEvento(data);
        maybeWarnCalendars(data);

        if (data.eventKey) currentEventKey = data.eventKey;
        setModoEvento();

        if (currentEventKey) {
          alert(`Evento guardado correctamente (${data.dias || data.diasActualizados || 0} dias)`);
        } else {
          alert("Datos guardados");
        }
      } catch (err) {
        mostrarMensajeEnviando(false);
        alert("Error al guardar evento");
      }
    });

    document.getElementById("buscarEventoTxt").addEventListener("input", () => {
      cargarListaEventos();
    });
    document.getElementById("soloUnDia").addEventListener("change", applySingleDayMode);
    function syncFechaFinConInicio() {
      const inicio = document.getElementById("fechaInicio").value;
      if (!inicio) return;
      document.getElementById("fechaFin").value = inicio;
    }
    document.getElementById("fechaInicio").addEventListener("change", syncFechaFinConInicio);
    document.getElementById("fechaInicio").addEventListener("input", syncFechaFinConInicio);
    window.addEventListener("resize", applyMobileUiTweaks);

    applyEnvironmentUi();
    applyMobileUiTweaks();
    checkBackendHealth();
    initMonthSelects();
    resetFormularioEvento();
  </script>
</body>
</html>




